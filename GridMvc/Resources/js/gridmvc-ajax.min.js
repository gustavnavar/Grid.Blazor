(function(n){var t=GridMvc.prototype,r={};for(var i in t)typeof t[i]=="function"&&(r[i]=t[i]);n.extend(!0,t,{parseFilterValues:function(t){for(var r=n.parseJSON(t),u=[],i=0;i<r.length;i++)u.push({filterValue:r[i].FilterValue,filterType:r[i].FilterType,columnName:r[i].ColumnName});return u},applyFilterValues:function(t,i,r,u){var f=this,o,s,e,l,h,c;if(f.gridColumnFilters=null,o=f.jqContainer.find(".grid-filter"),s=URI(t).normalizeSearch().search(),s.length>0&&(s+="&"),f.gridColumnFilters="",u||(f.gridColumnFilters+=this.getFilterQueryData(i,r)),this.options.multiplefilters){for(e=0;e<o.length;e++)if(n(o[e]).attr("data-name")!==i){if(l=this.parseFilterValues(n(o[e]).attr("data-filterdata")),l.length===0)continue;f.gridColumnFilters.length>0&&(f.gridColumnFilters+="&");f.gridColumnFilters+=this.getFilterQueryData(n(o[e]).attr("data-name"),l)}else continue;f.initialFilters.includes(i)&&!f.clearInitialFilters.includes(i)&&f.clearInitialFilters.push(i)}else for(h=0;h<f.initialFilters.length;h++)f.clearInitialFilters.includes(f.initialFilters[h])||f.clearInitialFilters.push(f.initialFilters[h]);f.gridColumnFilters.length>0&&(s+="&"+f.gridColumnFilters);c=s;c.indexOf("?")===-1&&(c="?"+c);f.gridColumnFilters=c;f.currentPage=this.options.currentPage?this.options.currentPage:1;f.loadPage()},applySearchValues:function(n,t){var i=this;i.gridSearch=t?"":this.getSearchQueryData(n);i.loadPage()},ajaxify:function(t){var i=this,r,u,f;i.currentPage=this.options.currentPage?this.options.currentPage:1;i.pagedDataAction=t.getPagedData;i.subGridDataAction=t.getSubGridData;i.data=t.data;i.token=t.token;i.gridSort=i.jqContainer.find("div.sorted a").attr("href");i.gridColumnFilters="";i.gridSearch="";r=n('[data-gridname="'+i.jqContainer.data("gridname")+'"]');i.jqContainer=r.length===1?r:i.jqContainer;i.gridSort&&(i.gridSort=i.gridSort.indexOf("grid-dir=0")!==-1?i.gridSort.replace("grid-dir=0","grid-dir=1"):i.gridSort.replace("grid-dir=1","grid-dir=0"),i.orginalSort=i.gridSort);u=i.jqContainer.attr("data-initfilters");i.initialFilters=null;i.initialFilters=u?u.split(","):[];f=i.jqContainer.find(".grid-filter").attr("data-clearinitfilter");i.clearInitialFilters=null;i.clearInitialFilters=f?f.split(","):[];i.getState=function(){var n={},u=URI.parseQuery(i.gridColumnFilters)["grid-filter"],r,f,e,t;return n["grid-filter"]=Array.isArray(u)?u.join("|"):u,r=URI.parseQuery(i.gridSearch)["grid-search"],n["grid-search"]=Array.isArray(r)?r.join("|"):r,i.gridSort&&(f=URI.parseQuery(i.gridSort),n["grid-column"]=f["grid-column"],n["grid-dir"]=f["grid-dir"]),i.clearInitialFilters&&(n["grid-clearinitfilter"]=i.clearInitialFilters.join("|")),n["grid-page"]=i.currentPage,e=JSON.stringify(n),t=btoa(e),t=t.replace("+","."),t=t.replace("/","_"),t.replace("=","-")};i.getGridUrl=function(n,t,r){var u=URI(n),s=URI.parseQuery(r),e,o,f;if(s["grid-search"]&&u.addSearch("grid-search",s["grid-search"]),e=URI.parseQuery(t),e["grid-filter"]&&u.addSearch("grid-filter",e["grid-filter"]),i.gridSort&&(o=URI.parseQuery(i.gridSort),u.addSearch("grid-column",o["grid-column"]),u.addSearch("grid-dir",o["grid-dir"])),i.clearInitialFilters)for(f=0;f<i.clearInitialFilters.length;f++)u.addSearch("grid-clearinitfilter",i.clearInitialFilters[f]);return u.removeQuery("grid-page"),u.addQuery("grid-page",i.currentPage),URI.decode(u)};i.getSubGridUrl=function(n,t,i){var u,r;if(t&&i&&t.length===i.length){for(u=URI(n),r=0;r<i.length;r++)u.addSearch(t[r],i[r]);return URI.decode(u)}};i.setupGridHeaderEvents=function(){i.jqContainer.find(".grid-header-title > a").each(function(){n(this).click(function(t){var r,u,f;i.gridSort="";t.preventDefault();i.jqContainer.find(".grid-header-title").removeClass("sorted-asc");i.jqContainer.find(".grid-header-title").removeClass("sorted-desc");r=n(this).attr("href");u=r.indexOf("grid-dir=1")!==-1;i.gridSort=r.substr(r.match(/grid-column=\w+/).index);i.loadPage();u?n(this).attr("href",r.replace("grid-dir=1","grid-dir=0")):n(this).attr("href",r.replace("grid-dir=0","grid-dir=1"));f=u?"sorted-desc":"sorted-asc";n(this).parent(".grid-header-title").addClass(f);n(this).parent(".grid-header-title").children("span").remove();n(this).parent(".grid-header-title").append(n("<span/>").addClass("grid-sort-arrow"))})});i.jqContainer.find(".grid-filter").each(function(){n(this).click(function(n){return n.preventDefault(),i.openFilterPopup.call(this,i,i.filterMenuHtml())})});i.jqContainer.find(".grid-search-apply").each(function(){n(this).click(function(n){n.preventDefault();var t=i.jqContainer.find(".grid-search-input").first().val();return i.applySearchValues(t,!1)})});i.jqContainer.find(".grid-search-clear").each(function(){n(this).click(function(n){return n.preventDefault(),i.applySearchValues("",!0)})})};i.setupPagerLinkEvents=function(){i.jqContainer.find(".grid-page-link").each(function(){n(this).click(function(t){t.preventDefault();var r=n(this).attr("data-page");i.currentPage=r;i.loadPage()})})};i.loadPage=function(){var t=new n.Deferred,r=i.getGridUrl(i.pagedDataAction,i.gridColumnFilters,i.gridSearch);return n.ajax({url:r,type:"POST",contentType:"application/json; charset=utf-8",data:i.data,headers:{RequestVerificationToken:i.token}}).done(function(t){i.jqContainer.hide();i.jqContainer.html(t);i.jqContainer.html(i.jqContainer.children().first().html());i.setupGridHeaderEvents();i.setupPagerLinkEvents();i.initFilters();i.initSearch();i.initSubGrids();i.jqContainer.show();i.notifyOnGridLoaded(t,n.Event("GridLoaded"))}).fail(function(){i.notifyOnGridError(null,n.Event("GridError"))}).always(function(n){t.resolve(n)}),t.promise()};i.loadSubGridPage=function(t,r,u,f){var e=new n.Deferred,o=i.getSubGridUrl(i.subGridDataAction,i.keys,t);return n.ajax({url:o,type:"POST",contentType:"application/json; charset=utf-8",headers:{RequestVerificationToken:i.token}}).done(function(n){r.html("<td><\/td><td colspan="+f+">"+n+"<\/td>");var t=r.find(".grid-mvc");t.gridmvc();window.pageGrids[t.attr("data-gridname")].ajaxify({getPagedData:o,token:i.token});u.attr("data-is-rendered","true")}).always(function(n){e.resolve(n)}),e.promise()};i.initFilters=function(){var u,f,t,e,r;if(i.gridColumnFilters=null,u=i.jqContainer.find(".grid-filter"),f=URI("").normalizeSearch().search(),i.gridColumnFilters="",this.options.multiplefilters)for(t=0;t<u.length;t++)(e=this.parseFilterValues(n(u[t]).attr("data-filterdata")),e.length!==0)&&(i.gridColumnFilters.length>0&&(i.gridColumnFilters+="&"),i.gridColumnFilters+=this.getFilterQueryData(n(u[t]).attr("data-name"),e));i.gridColumnFilters.length>0&&(f+="&"+i.gridColumnFilters);r=f;r.indexOf("?")===-1&&(r="?"+r);i.gridColumnFilters=r};i.initSearch=function(){i.gridSearch=null;var n=i.jqContainer.find(".grid-search-input").first().val();i.gridSearch=this.getSearchQueryData(n)};i.initSubGrids=function(){i.keys=[];var t=this.jqContainer.attr("data-keys");t&&(i.keys=t.split(","));this.jqContainer.find(".grid-subgrid").each(function(){n(this).click(function(t){var c,r,f,e,o,u,s,h;t.stopPropagation();c=n(this).parent().children().length;r=n(this).parent().next();r&&r.hasClass("subgrid-row")&&(f=n(this).attr("data-is-visible"),f&&f==="true"?(r.hide(),n(this).attr("data-is-visible","false"),e=n(this).find(".subgrid-caret-down"),e.removeClass("subgrid-caret-down"),e.addClass("subgrid-caret")):(o=n(this).attr("data-is-rendered"),o&&o==="false"&&(u=[],s=n(this).attr("data-values"),s&&(u=s.split(",")),i.keys&&i.keys.length===u.length&&i.loadSubGridPage(u,r,n(this),c-1)),n(this).parent().next().show(),n(this).attr("data-is-visible","true"),h=n(this).find(".subgrid-caret"),h.removeClass("subgrid-caret"),h.addClass("subgrid-caret-down")))})})};i.setupGridHeaderEvents();i.setupPagerLinkEvents();i.initFilters();i.initSearch();i.initSubGrids()},onGridLoaded:function(n){this.events.push({name:"onGridLoaded",callback:n})},notifyOnGridLoaded:function(n,t){t.data=n;this.notifyEvent("onGridLoaded",t)},onGridError:function(n){this.events.push({name:"onGridError",callback:n})},notifyOnGridError:function(n,t){t.data=n;this.notifyEvent("onGridError",t)}})})(jQuery);